<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Config · Timezone</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      .config-page { max-width: 760px; margin: 20px auto; padding: 0 20px; }
      .config-card { background: #fff; border: 1px solid #dbe7ef; border-radius: 16px; padding: 16px; box-shadow: 0 12px 32px rgba(2, 8, 23, .06); }
      .config-card h1 { margin: 0 0 8px; }
      .config-card p { color: #64748b; }
      .config-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
      .config-actions button.secondary { background: #f8fafc; color: #0f172a; border: 1px solid #cbd5e1; }
      .status-note { margin-top: 10px; font-weight: 700; color: #0f766e; }
    </style>
  </head>
  <body>
    <div class="top-nav-wrap">
      <nav class="top-nav" aria-label="Main navigation">
        <div class="top-nav-brand">AEMET Antarctica Analytics</div>
        <div class="top-nav-links">
          <a class="top-nav-link" href="/">Dashboard</a>
          <a class="top-nav-link active" href="/config">Config</a>
        </div>
      </nav>
    </div>
    <main class="config-page">
      <section class="config-card">
        <h1>Input Timezone Configuration</h1>
        <p>
          This timezone is used as the API <code>location</code> value for all queries.
          If you do not set a custom value, the dashboard uses your browser timezone.
        </p>

        <label>Detected browser timezone
          <input id="browser-timezone" type="text" readonly />
        </label>

        <label>Custom input timezone (IANA format, e.g. Europe/Madrid)
          <input id="custom-timezone" type="text" placeholder="America/Santiago" />
        </label>

        <div class="config-actions">
          <button id="save-custom" type="button">Save custom timezone</button>
          <button id="use-browser" type="button" class="secondary">Use browser timezone (default)</button>
        </div>
        <p class="status-note" id="config-status">Loading settings…</p>
      </section>
    </main>

    <script>
      (function () {
        const inputTimezoneStorageKey = 'aemet.input_timezone';
        const browserInput = document.getElementById('browser-timezone');
        const customInput = document.getElementById('custom-timezone');
        const statusEl = document.getElementById('config-status');
        const saveBtn = document.getElementById('save-custom');
        const resetBtn = document.getElementById('use-browser');

        function browserTimeZone() {
          const zone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          return zone && zone.trim() ? zone : 'UTC';
        }

        function isValidTimeZone(zone) {
          try {
            new Intl.DateTimeFormat(undefined, { timeZone: zone });
            return true;
          } catch {
            return false;
          }
        }

        function effectiveTimeZone() {
          const stored = localStorage.getItem(inputTimezoneStorageKey);
          const trimmed = stored ? stored.trim() : '';
          if (trimmed && isValidTimeZone(trimmed)) return trimmed;
          return browserTimeZone();
        }

        function hydrate() {
          const browser = browserTimeZone();
          const stored = localStorage.getItem(inputTimezoneStorageKey);
          browserInput.value = browser;
          customInput.value = stored ? stored : '';
          if (stored) {
            statusEl.textContent = 'Current input timezone: ' + effectiveTimeZone() + ' (custom)';
          } else {
            statusEl.textContent = 'Current input timezone: ' + effectiveTimeZone() + ' (browser default)';
          }
        }

        saveBtn.addEventListener('click', function () {
          const raw = customInput.value.trim();
          if (!raw) {
            statusEl.textContent = 'Enter an IANA timezone or use browser default.';
            return;
          }
          if (!isValidTimeZone(raw)) {
            statusEl.textContent = 'Invalid timezone. Example: Europe/Madrid, UTC, America/Santiago.';
            return;
          }
          localStorage.setItem(inputTimezoneStorageKey, raw);
          statusEl.textContent = 'Saved. Current input timezone: ' + raw + ' (custom)';
        });

        resetBtn.addEventListener('click', function () {
          localStorage.removeItem(inputTimezoneStorageKey);
          customInput.value = '';
          statusEl.textContent = 'Saved. Current input timezone: ' + effectiveTimeZone() + ' (browser default)';
        });

        hydrate();
      })();
    </script>
  </body>
</html>
